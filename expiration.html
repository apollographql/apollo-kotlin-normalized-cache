<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-10-10T12:53:20.95606095"><title>Expiration | apollo-kotlin-normalized-cache-incubating</title><script type="application/json" id="virtual-toc-data">[{"id":"server-controlled","level":0,"title":"Server-controlled","anchor":"#server-controlled"},{"id":"client-controlled","level":0,"title":"Client-controlled","anchor":"#client-controlled"},{"id":"maximum-staleness","level":0,"title":"Maximum staleness","anchor":"#maximum-staleness"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b267/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon-192x192.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Expiration | apollo-kotlin-normalized-cache-incubating"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="apollo-kotlin-normalized-cache-incubating Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/expiration.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Expiration | apollo-kotlin-normalized-cache-incubating"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/expiration.html#webpage",
    "url": "writerside-documentation/expiration.html",
    "name": "Expiration | apollo-kotlin-normalized-cache-incubating",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "apollo-kotlin-normalized-cache-incubating Help"
}</script><!-- End Schema.org --></head><body data-id="expiration" data-main-title="Expiration" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="" data-edit-url="https://github.com/apollographql/apollo-kotlin-normalized-cache-incubating/edit/main/Writerside/topics/expiration.md"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>apollo-kotlin-normalized-cache-incubating  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="expiration" id="expiration.md">Expiration</h1><section class="chapter"><h2 id="server-controlled" data-toc="server-controlled">Server-controlled</h2><p id="-qkmut1_2">When receiving a response from the server, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control" id="-qkmut1_3" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_4">Cache-Control</code> HTTP header</a> can be used to determine the <span class="control" id="-qkmut1_5">expiration date</span> of the fields in the response.</p><aside class="prompt" data-type="tip" data-title="" id="-qkmut1_6"><p id="-qkmut1_7">Apollo Server can be configured to include the <code class="code" id="-qkmut1_8">Cache-Control</code> header in responses. See the <a href="https://www.apollographql.com/docs/apollo-server/performance/caching/" id="-qkmut1_9" data-external="true" rel="noopener noreferrer">caching documentation</a> for more information.</p></aside><p id="-qkmut1_10">The cache can be configured to store the <span class="control" id="-qkmut1_11">expiration date</span> of the received fields in the corresponding records. To do so, call <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized/store-expiration-date.html?query=fun%20%3CT%3E%20MutableExecutionOptions%3CT%3E.storeExpirationDate(storeExpirationDate:%20Boolean):%20T" id="-qkmut1_12" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_13">.storeExpirationDate(true)</code></a>, and set your client's cache resolver to <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-expiration-cache-resolver/index.html" id="-qkmut1_14" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_15">ExpirationCacheResolver</code></a>:</p><div class="code-block" data-lang="kotlin">
val apolloClient = ApolloClient.builder()
  .serverUrl(&quot;https://example.com/graphql&quot;)
  .storeExpirationDate(true)
  .normalizedCache(
    normalizedCacheFactory = /*...*/,
    cacheResolver = ExpirationCacheResolver(),
  )
  .build()
</div><p id="-qkmut1_17"><span class="control" id="-qkmut1_18">Expiration dates</span> will be stored and when a field is resolved, the cache resolver will check if the field is expired. If so, it will throw a <code class="code" id="-qkmut1_19">CacheMissException</code>.</p></section><section class="chapter"><h2 id="client-controlled" data-toc="client-controlled">Client-controlled</h2><p id="-qkmut1_20">When storing fields, the cache can also store their <span class="control" id="-qkmut1_21">received date</span>. This date can then be compared to the current date when resolving a field to determine if its age is above its <span class="control" id="-qkmut1_22">maximum age</span>.</p><p id="-qkmut1_23">To store the <span class="control" id="-qkmut1_24">received date</span> of fields, call <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized/store-receive-date.html?query=fun%20%3CT%3E%20MutableExecutionOptions%3CT%3E.storeReceiveDate(storeReceiveDate:%20Boolean):%20T" id="-qkmut1_25" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_26">.storeReceivedDate(true)</code></a>, and set your client's cache resolver to <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-expiration-cache-resolver/index.html" id="-qkmut1_27" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_28">ExpirationCacheResolver</code></a>:</p><div class="code-block" data-lang="kotlin">
val apolloClient = ApolloClient.builder()
  .serverUrl(&quot;https://example.com/graphql&quot;)
  .storeReceivedDate(true)
  .normalizedCache(
    normalizedCacheFactory = /*...*/,
    cacheResolver = ExpirationCacheResolver(maxAgeProvider),
  )
  .build()
</div><aside class="prompt" data-type="tip" data-title="" id="-qkmut1_30"><p id="-qkmut1_31">Expiration dates and received dates can be both stored to combine server-controlled and client-controlled expiration strategies.</p></aside><p id="-qkmut1_32">The <span class="control" id="-qkmut1_33">maximum age</span> of fields can be configured either programmatically, or declaratively in the schema. This is done by passing a <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-max-age-provider/index.html?query=interface%20MaxAgeProvider" id="-qkmut1_34" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_35">MaxAgeProvider</code></a> to the <code class="code" id="-qkmut1_36">ExpirationCacheResolver</code>.</p><section class="chapter"><h3 id="global-max-age" data-toc="global-max-age">Global max age</h3><p id="-qkmut1_37">To set a global maximum age for all fields, pass a <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-global-max-age-provider/index.html?query=class%20GlobalMaxAgeProvider(maxAge:%20Duration)%20:%20MaxAgeProvider" id="-qkmut1_38" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_39">GlobalMaxAgeProvider</code></a> to the <code class="code" id="-qkmut1_40">ExpirationCacheResolver</code>:</p><div class="code-block" data-lang="kotlin">
    cacheResolver = ExpirationCacheResolver(GlobalMaxAgeProvider(1.hours)),
</div></section><section class="chapter"><h3 id="max-age-per-type-and-field" data-toc="max-age-per-type-and-field">Max age per type and field</h3><section class="chapter"><h4 id="programmatically" data-toc="programmatically">Programmatically</h4><p id="-qkmut1_42">Use a <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-schema-coordinates-max-age-provider/index.html?query=class%20SchemaCoordinatesMaxAgeProvider(maxAges:%20Map%3CString,%20MaxAge%3E,%20defaultMaxAge:%20Duration)%20:%20MaxAgeProvider" id="-qkmut1_43" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_44">SchemaCoordinatesMaxAgeProvider</code></a> to specify a max age per type and/or field:</p><div class="code-block" data-lang="kotlin">
    cacheResolver = ExpirationCacheResolver(SchemaCoordinatesMaxAgeProvider(
      maxAges = mapOf(
        &quot;Query.cachedBook&quot; to MaxAge.Duration(60.seconds),
        &quot;Query.reader&quot; to MaxAge.Duration(40.seconds),
        &quot;Post&quot; to MaxAge.Duration(4.minutes),
        &quot;Book.cachedTitle&quot; to MaxAge.Duration(30.seconds),
        &quot;Reader.book&quot; to MaxAge.Inherit,
      ),
      defaultMaxAge = 1.hours,
    )),
</div><p id="-qkmut1_46">Note that this provider replicates the behavior of Apollo Server's <a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#default-maxage" id="-qkmut1_47" data-external="true" rel="noopener noreferrer"><code class="code" id="-qkmut1_48">@cacheControl</code> directive</a> when it comes to defaults and the meaning of <code class="code" id="-qkmut1_49">Inherit</code>.</p></section><section class="chapter"><h4 id="declaratively" data-toc="declaratively">Declaratively</h4><p id="-qkmut1_50">To declare the maximum age of types and fields in the schema, use the <code class="code" id="-qkmut1_51">@cacheControl</code> and <code class="code" id="-qkmut1_52">@cacheControlField</code> directive:</p><div class="code-block" data-lang="none">
# First import the directives
extend schema @link(
  url: &quot;https://specs.apollo.dev/cache/v0.1&quot;,
  import: [&quot;@cacheControl&quot;, &quot;@cacheControlField&quot;]
)

# Then extend your types
extend type Query @cacheControl(maxAge: 60)
  @cacheControlField(name: &quot;cachedBook&quot;, maxAge: 60)
  @cacheControlField(name: &quot;reader&quot;, maxAge: 40)

extend type Post @cacheControl(maxAge: 240)

extend type Book @cacheControlField(name: &quot;cachedTitle&quot;, maxAge: 30)

extend type Reader @cacheControlField(name: &quot;book&quot;, inheritMaxAge: true)
</div><p id="-qkmut1_54">Then configure the Cache compiler plugin in your <code class="code" id="-qkmut1_55">build.gradle.kts</code>:</p><div class="code-block" data-lang="kotlin">
apollo {
  service(&quot;service&quot;) {
    packageName.set(/*...*/)

    plugin(&quot;com.apollographql.cache:normalized-cache-apollo-compiler-plugin:0.0.3&quot;) {
      argument(&quot;packageName&quot;, packageName.get())
    }
  }
}
</div><p id="-qkmut1_57">This will generate a map in <code class="code" id="-qkmut1_58">yourpackage.cache.Cache.maxAges</code>, that you can pass to the <code class="code" id="-qkmut1_59">SchemaCoordinatesMaxAgeProvider</code>:</p><div class="code-block" data-lang="kotlin">
    cacheResolver = ExpirationCacheResolver(SchemaCoordinatesMaxAgeProvider(
      maxAges = Cache.maxAges,
      defaultMaxAge = 1.hours,
    )),
</div></section></section></section><section class="chapter"><h2 id="maximum-staleness" data-toc="maximum-staleness">Maximum staleness</h2><p id="-qkmut1_61">If expired fields are acceptable up to a certain value, you can set a maximum staleness duration. This duration is the maximum time that an expired field will be resolved without resulting in a cache miss. To set this duration, call <code class="code" id="-qkmut1_62">.maxStale(Duration)</code> either globally on your client, or per operation:</p><div class="code-block" data-lang="kotlin">
client.query(MyQuery())
  .fetchPolicy(FetchPolicy.CacheOnly)
  .maxStale(1.hours)
  .execute()
</div></section><div class="last-modified">Last modified: 04 October 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="pagination.html" class="navigation-links__prev">Pagination</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b267/app.js"></script></body></html>
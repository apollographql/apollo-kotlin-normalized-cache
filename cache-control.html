<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-12-20T10:49:48.172606043"><title>Cache control | apollo-kotlin-normalized-cache-incubating</title><script type="application/json" id="virtual-toc-data">[{"id":"server-controlled","level":0,"title":"Server-controlled","anchor":"#server-controlled"},{"id":"client-controlled","level":0,"title":"Client-controlled","anchor":"#client-controlled"},{"id":"maximum-staleness","level":0,"title":"Maximum staleness","anchor":"#maximum-staleness"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b267/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon-192x192.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Cache control | apollo-kotlin-normalized-cache-incubating"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="apollo-kotlin-normalized-cache-incubating Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/cache-control.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Cache control | apollo-kotlin-normalized-cache-incubating"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/cache-control.html#webpage",
    "url": "writerside-documentation/cache-control.html",
    "name": "Cache control | apollo-kotlin-normalized-cache-incubating",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "apollo-kotlin-normalized-cache-incubating Help"
}</script><!-- End Schema.org --></head><body data-id="cache-control" data-main-title="Cache control" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="" data-edit-url="https://github.com/apollographql/apollo-kotlin-normalized-cache-incubating/edit/main/Writerside/topics/cache-control.md"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>apollo-kotlin-normalized-cache-incubating  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="cache-control" id="cache-control.md">Cache control</h1><p id="-nhgx0n_2">The cache control feature takes the freshness of fields into consideration when accessing the cache. This is also sometimes referred to as TTL (Time To Live) or expiration.</p><p id="-nhgx0n_3">Freshness can be configured by the server, by the client, or both.</p><section class="chapter"><h2 id="server-controlled" data-toc="server-controlled">Server-controlled</h2><p id="-nhgx0n_4">When receiving a response from the server, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control" id="-nhgx0n_5" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_6">Cache-Control</code> HTTP header</a> can be used to determine the <span class="control" id="-nhgx0n_7">expiration date</span> of the fields in the response.</p><aside class="prompt" data-type="tip" data-title="" id="-nhgx0n_8"><p id="-nhgx0n_9">Apollo Server can be configured to include the <code class="code" id="-nhgx0n_10">Cache-Control</code> header in responses. See the <a href="https://www.apollographql.com/docs/apollo-server/performance/caching/" id="-nhgx0n_11" data-external="true" rel="noopener noreferrer">caching documentation</a> for more information.</p></aside><p id="-nhgx0n_12">The cache can be configured to store the <span class="control" id="-nhgx0n_13">expiration date</span> of the received fields in the corresponding records. To do so, call <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized/store-expiration-date.html?query=fun%20%3CT%3E%20MutableExecutionOptions%3CT%3E.storeExpirationDate(storeExpirationDate:%20Boolean):%20T" id="-nhgx0n_14" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_15">.storeExpirationDate(true)</code></a>, and set your client's cache resolver to <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-cache-control-cache-resolver/index.html" id="-nhgx0n_16" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_17">CacheControlCacheResolver</code></a>:</p><div class="code-block" data-lang="kotlin">
val apolloClient = ApolloClient.builder()
  .serverUrl(&quot;https://example.com/graphql&quot;)
  .storeExpirationDate(true)
  .normalizedCache(
    normalizedCacheFactory = /*...*/,
    cacheResolver = CacheControlCacheResolver(),
  )
  .build()
</div><p id="-nhgx0n_19"><span class="control" id="-nhgx0n_20">Expiration dates</span> will be stored and when a field is resolved, the cache resolver will check if the field is stale. If so, it will throw a <code class="code" id="-nhgx0n_21">CacheMissException</code>.</p></section><section class="chapter"><h2 id="client-controlled" data-toc="client-controlled">Client-controlled</h2><p id="-nhgx0n_22">When storing fields, the cache can also store their <span class="control" id="-nhgx0n_23">received date</span>. This date can then be compared to the current date when resolving a field to determine if its age is above its <span class="control" id="-nhgx0n_24">maximum age</span>.</p><p id="-nhgx0n_25">To store the <span class="control" id="-nhgx0n_26">received date</span> of fields, call <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized/store-receive-date.html?query=fun%20%3CT%3E%20MutableExecutionOptions%3CT%3E.storeReceiveDate(storeReceiveDate:%20Boolean):%20T" id="-nhgx0n_27" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_28">.storeReceivedDate(true)</code></a>, and set your client's cache resolver to <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-cache-control-cache-resolver/index.html" id="-nhgx0n_29" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_30">CacheControlCacheResolver</code></a>:</p><div class="code-block" data-lang="kotlin">
val apolloClient = ApolloClient.builder()
  .serverUrl(&quot;https://example.com/graphql&quot;)
  .storeReceivedDate(true)
  .normalizedCache(
    normalizedCacheFactory = /*...*/,
    cacheResolver = CacheControlCacheResolver(maxAgeProvider),
  )
  .build()
</div><aside class="prompt" data-type="tip" data-title="" id="-nhgx0n_32"><p id="-nhgx0n_33">Expiration dates and received dates can be both stored to combine server-controlled and client-controlled expiration strategies.</p></aside><p id="-nhgx0n_34">The <span class="control" id="-nhgx0n_35">maximum age</span> of fields can be configured either programmatically, or declaratively in the schema. This is done by passing a <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-max-age-provider/index.html?query=interface%20MaxAgeProvider" id="-nhgx0n_36" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_37">MaxAgeProvider</code></a> to the <code class="code" id="-nhgx0n_38">CacheControlCacheResolver</code>.</p><section class="chapter"><h3 id="global-max-age" data-toc="global-max-age">Global max age</h3><p id="-nhgx0n_39">To set a global maximum age for all fields, pass a <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-global-max-age-provider/index.html?query=class%20GlobalMaxAgeProvider(maxAge:%20Duration)%20:%20MaxAgeProvider" id="-nhgx0n_40" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_41">GlobalMaxAgeProvider</code></a> to the <code class="code" id="-nhgx0n_42">CacheControlCacheResolver</code>:</p><div class="code-block" data-lang="kotlin">
    cacheResolver = CacheControlCacheResolver(GlobalMaxAgeProvider(1.hours)),
</div></section><section class="chapter"><h3 id="max-age-per-type-and-field" data-toc="max-age-per-type-and-field">Max age per type and field</h3><section class="chapter"><h4 id="programmatically" data-toc="programmatically">Programmatically</h4><p id="-nhgx0n_44">Use a <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized.api/-schema-coordinates-max-age-provider/index.html?query=class%20SchemaCoordinatesMaxAgeProvider(maxAges:%20Map%3CString,%20MaxAge%3E,%20defaultMaxAge:%20Duration)%20:%20MaxAgeProvider" id="-nhgx0n_45" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_46">SchemaCoordinatesMaxAgeProvider</code></a> to specify a max age per type and/or field:</p><div class="code-block" data-lang="kotlin">
cacheResolver = CacheControlCacheResolver(
  SchemaCoordinatesMaxAgeProvider(
    maxAges = mapOf(
      &quot;Query.cachedBook&quot; to MaxAge.Duration(60.seconds),
      &quot;Query.reader&quot; to MaxAge.Duration(40.seconds),
      &quot;Post&quot; to MaxAge.Duration(4.minutes),
      &quot;Book.cachedTitle&quot; to MaxAge.Duration(30.seconds),
      &quot;Reader.book&quot; to MaxAge.Inherit,
    ), 
    defaultMaxAge = 1.hours,
  )
),
</div><p id="-nhgx0n_48">Note that this provider replicates the behavior of Apollo Server's <a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#default-maxage" id="-nhgx0n_49" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_50">@cacheControl</code> directive</a> when it comes to defaults and the meaning of <code class="code" id="-nhgx0n_51">Inherit</code>.</p></section><section class="chapter"><h4 id="declaratively" data-toc="declaratively">Declaratively</h4><p id="-nhgx0n_52">To declare the maximum age of types and fields in the schema, use the <code class="code" id="-nhgx0n_53">@cacheControl</code> and <code class="code" id="-nhgx0n_54">@cacheControlField</code> directive:</p><div class="code-block" data-lang="none">
# First import the directives
extend schema @link(
  url: &quot;https://specs.apollo.dev/cache/v0.1&quot;,
  import: [&quot;@cacheControl&quot;, &quot;@cacheControlField&quot;]
)

# Then extend your types
extend type Query @cacheControl(maxAge: 60)
  @cacheControlField(name: &quot;cachedBook&quot;, maxAge: 60)
  @cacheControlField(name: &quot;reader&quot;, maxAge: 40)

extend type Post @cacheControl(maxAge: 240)

extend type Book @cacheControlField(name: &quot;cachedTitle&quot;, maxAge: 30)

extend type Reader @cacheControlField(name: &quot;book&quot;, inheritMaxAge: true)
</div><p id="-nhgx0n_56">Then configure the Cache compiler plugin in your <code class="code" id="-nhgx0n_57">build.gradle.kts</code>:</p><div class="code-block" data-lang="kotlin">
apollo {
  service(&quot;service&quot;) {
    packageName.set(/*...*/)

    plugin(&quot;com.apollographql.cache:normalized-cache-apollo-compiler-plugin:0.0.5&quot;) {
      argument(&quot;packageName&quot;, packageName.get())
    }
  }
}
</div><p id="-nhgx0n_59">This will generate a map in <code class="code" id="-nhgx0n_60">yourpackage.cache.Cache.maxAges</code>, that you can pass to the <code class="code" id="-nhgx0n_61">SchemaCoordinatesMaxAgeProvider</code>:</p><div class="code-block" data-lang="kotlin">
cacheResolver = CacheControlCacheResolver(
  SchemaCoordinatesMaxAgeProvider(
    maxAges = Cache.maxAges,
    defaultMaxAge = 1.hours,
  )
),
</div></section></section></section><section class="chapter"><h2 id="maximum-staleness" data-toc="maximum-staleness">Maximum staleness</h2><p id="-nhgx0n_63">If stale fields are acceptable up to a certain value, you can set a maximum staleness duration. This duration is the maximum time that a stale field will be resolved without resulting in a cache miss. To set this duration, call <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized/max-stale.html?query=fun%20%3CT%3E%20MutableExecutionOptions%3CT%3E.maxStale(maxStale:%20Duration):%20T" id="-nhgx0n_64" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_65">.maxStale(Duration)</code></a> either globally on your client, or per operation:</p><div class="code-block" data-lang="kotlin">
val response = client.query(MyQuery())
    .fetchPolicy(FetchPolicy.CacheOnly)
    .maxStale(1.hours)
    .execute()
</div><section class="chapter"><h3 id="isstale" data-toc="isstale"><code class="code" id="-nhgx0n_68">isStale</code></h3><p id="-nhgx0n_69">With <code class="code" id="-nhgx0n_70">maxStale</code>, it is possible to get data from the cache even if it is stale. To know if the response contains stale fields, you can check <a href="https://apollographql.github.io/apollo-kotlin-normalized-cache-incubating/kdoc/normalized-cache-incubating/com.apollographql.cache.normalized/-cache-info/is-stale.html" id="-nhgx0n_71" data-external="true" rel="noopener noreferrer"><code class="code" id="-nhgx0n_72">CacheInfo.isStale</code></a>:</p><div class="code-block" data-lang="kotlin">
if (response.cacheInfo?.isStale == true) {
  // The response contains at least one stale field
}
</div></section></section><div class="last-modified">Last modified: 29 October 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="pagination-manual.html" class="navigation-links__prev">Managing pagination manually</a><a href="garbage-collection.html" class="navigation-links__next">Garbage collection</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b267/app.js"></script></body></html>